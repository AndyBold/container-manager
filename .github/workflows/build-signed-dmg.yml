name: Build Signed DMG

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      # Optional: Import signing certificates
      # To use this, you need to:
      # 1. Export your Developer ID Application certificate as .p12
      # 2. Base64 encode it: base64 -i certificate.p12 | pbcopy
      # 3. Add it as a GitHub secret named MACOS_CERTIFICATE
      # 4. Add the certificate password as MACOS_CERTIFICATE_PWD
      - name: Import Code Signing Certificates
        if: ${{ secrets.MACOS_CERTIFICATE != '' }}
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}
      
      - name: Build app (Signed)
        if: ${{ secrets.MACOS_CERTIFICATE != '' }}
        run: |
          xcodebuild clean build \
            -scheme container-manager \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            OTHER_CODE_SIGN_FLAGS="--timestamp --options=runtime" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}"
      
      - name: Build app (Unsigned)
        if: ${{ secrets.MACOS_CERTIFICATE == '' }}
        run: |
          xcodebuild clean build \
            -scheme container-manager \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Find built app
        id: find_app
        run: |
          APP_PATH=$(find ./build -name "container-manager.app" -type d | head -n 1)
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app at: $APP_PATH"
          ls -la "$APP_PATH"
      
      # Optional: Notarize the app (requires Apple Developer account)
      - name: Notarize app
        if: ${{ secrets.MACOS_CERTIFICATE != '' && secrets.NOTARIZATION_USERNAME != '' }}
        run: |
          # Create a ZIP for notarization
          ditto -c -k --keepParent "${{ steps.find_app.outputs.app_path }}" container-manager.zip
          
          # Submit for notarization
          xcrun notarytool submit container-manager.zip \
            --apple-id "${{ secrets.NOTARIZATION_USERNAME }}" \
            --password "${{ secrets.NOTARIZATION_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait
          
          # Staple the notarization ticket
          xcrun stapler staple "${{ steps.find_app.outputs.app_path }}"
      
      - name: Install create-dmg
        run: brew install create-dmg
      
      - name: Create DMG
        run: |
          # Create a folder for DMG contents
          mkdir -p dmg_contents
          
          # Copy the app to the DMG folder
          cp -R "${{ steps.find_app.outputs.app_path }}" dmg_contents/
          
          # Get version from tag or use "dev"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(date +%Y%m%d)"
          fi
          
          DMG_NAME="container-manager-${VERSION}.dmg"
          
          # Create the DMG
          create-dmg \
            --volname "Container Manager" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "container-manager.app" 175 120 \
            --hide-extension "container-manager.app" \
            --app-drop-link 425 120 \
            --no-internet-enable \
            "$DMG_NAME" \
            "dmg_contents/" || \
          hdiutil create -volname "Container Manager" -srcfolder dmg_contents -ov -format UDZO "$DMG_NAME"
          
          echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
          ls -lh "$DMG_NAME"
        id: create_dmg
      
      # Optional: Sign the DMG itself
      - name: Sign DMG
        if: ${{ secrets.MACOS_CERTIFICATE != '' }}
        run: |
          codesign --sign "Developer ID Application" --timestamp *.dmg || true
      
      - name: Upload DMG as artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-manager-dmg
          path: "*.dmg"
          retention-days: 90
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: "*.dmg"
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
